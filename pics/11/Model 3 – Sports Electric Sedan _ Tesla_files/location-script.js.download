(function(){"use strict";const D=e=>{const o=document.cookie.split("; ");for(const i of o){const[O,n]=i.split("=");if(O===e)return E(t.COOKIE_READ,{label:`${O}`}),n}return null},S=(e,o)=>{if(!e||!o){console.error("Cookie name and value required to write the cookie"),E(t.COOKIE_NAME_ERROR);return}if((window==null?void 0:window.tslaCookieConsentDecision)==="accepted"){console.info("[Location Script] Writing cookie",{cookieName:e});const i=typeof o=="object"?JSON.stringify(o):o;document.cookie=`${e}=${i}; path=/;`,E(t.COOKIE_WRITTEN,{label:`${e}`})}else console.info("[Location Script] Not allowed to write cookie",{cookieName:e})},p=e=>{document.cookie=`${e}=; path=/; expires = Thu, 01 Jan 1970 00:00:00 GMT`,E(t.COOKIE_DELETED,{labels:`${e}`})},C=(e,o)=>{const i=new CustomEvent(e,{detail:o});document.dispatchEvent(i)},f=async()=>{const e=D(a.IP_INFO);if(e)try{const o={...JSON.parse(e),source:a.IP_INFO};C(l.ADDRESS_DATA,o)}catch(o){E(t.IP_INFO_DISPATCH_ERROR,{label:o}),console.error("Error dispatching ip_info cookie data,",o),await L()}else await L()};var l=(e=>(e.ADDRESS_DATA="addressData",e))(l||{}),a=(e=>(e.DEVICE_LOCATION="device_location",e.PREFERRED_ADDRESS="preferred_address",e.IP_INFO="ip_info",e.LOCATION_PERMISSION="location_permission",e))(a||{});const P={progressHandler:()=>{},fallback:!1,isGpsEnabled:!0,useBaidu:!1};var t=(e=>(e.REQUEST="REQUEST",e.PREFERRED_ADDRESS_EXISTS="PREFERRED_ADDRESS_EXISTS",e.PREFERRED_ADDRESS_DISPATCH_ERROR="PREFERRED_ADDRESS_DISPATCH_ERROR",e.DEVICE_LOCATION_EXISTS="DEVICE_LOCATION_EXISTS",e.DEVICE_LOCATION_DISPATCH_ERROR="DEVICE_LOCATION_DISPATCH_ERROR",e.IP_INFO_EXISTS="IP_INFO_EXISTS",e.LOCATION_PERMISSION="LOCATION_PERMISSION",e.FALLBACK_ERROR="FALLBACK_ERROR",e.LOCATION_FROM_GEOIP="LOCATION_FROM_GEOIP",e.LOCATION_PERMISSION_GRANTED="LOCATION_PERMISSION_GRANTED",e.LOCATION_PERMISSION_DENIED="LOCATION_PERMISSION_DENIED",e.LOCATION_PERMISSION_ERROR="LOCATION_PERMISSION_ERROR",e.DEVICE_LOCATION_WRITTEN="DEVICE_LOCATION_WRITTEN",e.IP_INFO_WRITTEN="IP_INFO_WRITTEN",e.IP_INFO_READ_ERROR="IP_INFO_READ_ERROR",e.COOKIE_CONSENT_ACCEPTED="COOKIE_CONSENT_ACCEPTED",e.COOKIE_CONSENT_REJECTED="COOKIE_CONSENT_REJECTED",e.COOKIE_READ="COOKIE_READ",e.COOKIE_WRITTEN="COOKIE_WRITTEN",e.COOKIE_DELETED="COOKIE_DELETED",e.COOKIE_NAME_ERROR="COOKIE_NAME_ERROR",e.EMEA_TRUE="EMEA_TRUE",e.EMEA_FALSE="EMEA_FALSE",e.GET_DEFAULT_LOCATION="GET_DEFAULT_LOCATION",e.GET_GEOCODING="GET_GEOCODING",e.GET_GEOCODING_SUCCESS="GET_GEOCODING_SUCCESS",e.GET_GEOCODING_FAILED="GET_GEOCODING_FAILED",e.GET_LOCATION="GET_LOCATION",e.GET_LOCATION_CALL_SUCCESS="GET_LOCATION_CALL_SUCCESS",e.GET_LOCATION_CALL_FAILED="GET_LOCATION_CALL_FAILED",e.GET_DEFAULT_LOCATION_ERROR="GET_DEFAULT_LOCATION_ERROR",e.GET_GEOCODING_ERROR="GET_GEOCODING_ERROR",e.ASK_LOCATION_PERMISSION_ERROR="ASK_LOCATION_PERMISSION_ERROR",e.LAT_LONG_ERROR="LAT_LONG_ERROR",e.FALLBACK_ENABLED="FALLBACK_ENABLED",e.FALLBACK_DISABLED="FALLBACK_DISABLED",e.GPS_ENABLED="GPS_ENABLED",e.PERMISSION_CHANGE="PERMISSION_CHANGE",e.LOCATION_HOST_ERROR="LOCATION_HOST_ERROR",e.IP_INFO_DISPATCH_ERROR="IP_INFO_DISPATCH_ERROR",e))(t||{});const g={REQUEST:"request",PREFERRED_ADDRESS_EXISTS:"preferred_address_exists",PREFERRED_ADDRESS_DISPATCH_ERROR:"preferred_address_dispatch_error",DEVICE_LOCATION_EXISTS:"device_location_exists",DEVICE_LOCATION_DISPATCH_ERROR:"device_location_dispatch_error",IP_INFO_EXISTS:"ip_info_exists",LOCATION_PERMISSION:"location_permission",FALLBACK_ERROR:"fallback_error",LOCATION_FROM_GEOIP:"location_from_geoip",LOCATION_PERMISSION_GRANTED:"location_permission_granted",DEVICE_LOCATION_WRITTEN:"device_location_written",LOCATION_PERMISSION_DENIED:"location_permission_denied",LOCATION_PERMISSION_ERROR:"location_permission_error",IP_INFO_WRITTEN:"ip_info_written",IP_INFO_READ_ERROR:"ip_info_read_error",COOKIE_CONSENT_ACCEPTED:"cookie_consent_accepted",COOKIE_CONSENT_REJECTED:"cookie_consent_rejected",COOKIE_READ:"cookie_read",COOKIE_WRITTEN:"cookie_written",COOKIE_DELETED:"cookie_deleted",COOKIE_NAME_ERROR:"cookie_name_error",EMEA_TRUE:"emea-true",EMEA_FALSE:"emea-false",GET_DEFAULT_LOCATION:"get_default_location",GET_GEOCODING:"get_geocoding",GET_GEOCODING_SUCCESS:"get_geocoding_sucess",GET_GEOCODING_FAILED:"get_geocoding_failed",GET_LOCATION:"get_location",GET_LOCATION_CALL_SUCCESS:"get_location_call_success",GET_LOCATION_CALL_FAILED:"get_location_call_failed",GET_DEFAULT_LOCATION_ERROR:"get_default_location_error",GET_GEOCODING_ERROR:"get_geocoding_error",ASK_LOCATION_PERMISSION_ERROR:"ask_location_permission_error",LAT_LONG_ERROR:"lat_long_error",FALLBACK_ENABLED:"fallback_enabled",FALLBACK_DISABLED:"fallback_disabled",GPS_ENABLED:"gps_enabled",PERMISSION_CHANGE:"permission_change",LOCATION_HOST_ERROR:"location_host_error",IP_INFO_DISPATCH_ERROR:"ip_info_dispatch_error"},h="location_script",E=(e,o)=>{var i;if(e)try{let O=g[e];const n={event:h,interaction:`${O}`,...o};(i=window.dataLayer)==null||i.push(n)}catch{throw new Error("Issue pushing interaction to GA")}};async function L(){var i,O,n,s,_,R,I,c,T,u;const e="https://location-services-prd.tesla.com/geoip";E(t.GET_DEFAULT_LOCATION);const o=`${e}/city`;try{const r=await(await fetch(o)).json(),A=(i=r==null?void 0:r.subdivisions)==null?void 0:i[0],y=A?{longName:((O=A==null?void 0:A.names)==null?void 0:O.en)??"",regionCode:(A==null?void 0:A.iso_code)??""}:null,d={ip:(r==null?void 0:r.ip)??"",location:{latitude:((n=r==null?void 0:r.location)==null?void 0:n.latitude)??"",longitude:((s=r==null?void 0:r.location)==null?void 0:s.longitude)??""},region:y,city:((R=(_=r==null?void 0:r.city)==null?void 0:_.names)==null?void 0:R.en)??"",country:((c=(I=r==null?void 0:r.country)==null?void 0:I.names)==null?void 0:c.en)??"",countryCode:((T=r==null?void 0:r.country)==null?void 0:T.iso_code)??"",postalCode:((u=r==null?void 0:r.postal)==null?void 0:u.code)??""};window.locationInfo.ipInfo=d,S(a.IP_INFO,d),C(l.ADDRESS_DATA,{...d,source:a.IP_INFO})}catch(N){throw C(l.ADDRESS_DATA,null),E(t.GET_DEFAULT_LOCATION_ERROR,{label:N}),new Error("fetching initial location",N)}}function F(e,o,i=!1){let O="https://www.tesla.com",n=`/cua-api/drive/get-geocoding?latitude=${e}&longitude=${o}`;return i&&(O="https://www.tesla.cn",n=`/cua-api/drive/get-reverse-geocoding-baidu?latitude=${e}&longitude=${o}`),`${O}${n}`}async function w(e,o,i=!1){if(!e||!o)throw E(t.LAT_LONG_ERROR),new Error("Latitude and Longitude is required");E(t.GET_GEOCODING);const O=F(e,o,i);try{const s=await(await fetch(O)).json();if(s!=null&&s.success){const _=s==null?void 0:s.data;window.locationInfo.deviceLocation=_,S(a.DEVICE_LOCATION,_),C(l.ADDRESS_DATA,{..._,source:a.DEVICE_LOCATION}),E(t.GET_GEOCODING_SUCCESS)}else throw E(t.GET_GEOCODING_FAILED),new Error("geolocation data is empty")}catch(n){throw C(l.ADDRESS_DATA,null),E(t.GET_DEFAULT_LOCATION_ERROR,{label:n}),new Error("fetching geolocation data:",n)}}function G(e=()=>{},o=!1){const i={enableHighAccuracy:!0,timeout:1e4,maximumAge:0};E(t.GET_LOCATION);async function O(R){var I;try{let c=R.coords;e(),await w(c.latitude,c.longitude,o),!((I=window.locationInfo)!=null&&I.isListenerAttached)&&s()}catch(c){console.error(c),E(t.GET_GEOCODING_ERROR,{label:`${c}`}),await n({code:0,message:c})}E(t.GET_LOCATION_CALL_SUCCESS)}async function n(R){var I;console.warn(`ERROR(${R.code}): ${R.message}, Fetching default location`);try{e();const c=D(a.PREFERRED_ADDRESS);if(c){const T={...JSON.parse(c),source:a.PREFERRED_ADDRESS};C(l.ADDRESS_DATA,T)}else await L();!((I=window.locationInfo)!=null&&I.isListenerAttached)&&s()}catch(c){E(t.GET_DEFAULT_LOCATION_ERROR,{label:`${c}`}),console.error(c)}E(t.GET_LOCATION_CALL_FAILED)}function s(){var R;E(t.PERMISSION_CHANGE),(R=navigator==null?void 0:navigator.permissions)==null||R.query({name:"geolocation"}).then(I=>{I.state!=="prompt"&&(window.locationInfo.isListenerAttached=!0,I.onchange=()=>{var T;["granted","denied"].includes(I.state)&&(e(),I.state==="denied"&&(delete window.locationInfo.deviceLocation,p(a.DEVICE_LOCATION)),(T=navigator==null?void 0:navigator.geolocation)==null||T.getCurrentPosition(O,n,i))})})}function _(){var R;try{navigator!=null&&navigator.geolocation&&((R=navigator==null?void 0:navigator.permissions)==null||R.query({name:"geolocation"}).then(I=>{var c;["prompt","granted","denied"].includes(I.state)&&((c=navigator==null?void 0:navigator.geolocation)==null||c.getCurrentPosition(O,n,i)),E(t.LOCATION_PERMISSION)}))}catch(I){throw E(t.ASK_LOCATION_PERMISSION_ERROR,{label:`${I}`}),new Error("Error asking user location permission,",I)}}return{askLocationPermission:_,handlePermissionChange:s}}console.info("Location script loaded");const m=e=>{if(e&&typeof e!="object"){console.error("Invalid config provided");return}const o={...P,...e},{fallback:i,isGpsEnabled:O}=o,{askLocationPermission:n,handlePermissionChange:s}=G(o.progressHandler,o.useBaidu);s();try{const _=D(a.PREFERRED_ADDRESS);if(_){const R={...JSON.parse(_),source:a.PREFERRED_ADDRESS};C(l.ADDRESS_DATA,R),E(t.PREFERRED_ADDRESS_EXISTS);return}}catch(_){console.error("Error dispatching preferred_address cookie data,",_),E(t.PREFERRED_ADDRESS_DISPATCH_ERROR,{label:_})}try{const _=D(a.DEVICE_LOCATION);if(_){const R={...JSON.parse(_),source:a.DEVICE_LOCATION};C(l.ADDRESS_DATA,R),E(t.DEVICE_LOCATION_EXISTS);return}}catch(_){console.error("Error dispatching device_location cookie data,",_),E(t.DEVICE_LOCATION_DISPATCH_ERROR,{label:_})}if(i&&(f(),E(t.FALLBACK_ENABLED)),O){E(t.GPS_ENABLED);try{n()}catch(_){console.error(_),E(t.LOCATION_PERMISSION_ERROR,{label:_}),L()}}else i||(E(t.FALLBACK_DISABLED),f())};window.runLocationDetection=m,window.writeCookie=S,window.locationInfo={isListenerAttached:!1,ipInfo:null,deviceLocation:null},document.addEventListener("tsla-cookie-consent",e=>{var O,n;const o=(O=window==null?void 0:window.locationInfo)==null?void 0:O.deviceLocation,i=(n=window==null?void 0:window.locationInfo)==null?void 0:n.ipInfo;window.tslaCookieConsentDecision=e.detail.decision,e.detail.decision==="accepted"?(E(t.COOKIE_CONSENT_ACCEPTED),o&&S(a.DEVICE_LOCATION,o),i&&S(a.IP_INFO,i)):e.detail.decision==="rejected"&&E(t.COOKIE_CONSENT_REJECTED)})})();
